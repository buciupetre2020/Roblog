{"title":"Geografia excesului de mortalitate","markdown":{"yaml":{"title":"Geografia excesului de mortalitate","description":"În ce regiuni a lovit pandemia cel mai tare ?\n","author":[{"name":"Petre Buciu","url":{}}],"knitr":{"opts_chunk":{"fig.align":"center"}},"date":"06-07-2023"},"headingText":"Analiză exploratorie","containsRefs":false,"markdown":"\n\n\nSă explorăm datele de la Eurostat, tabelul foarte mare cu date despre numărul de decese săptămânal la nivel de regiune NUTS 3 şi pe categorii de vârstă numit `demo_r_mwk3_10`. Vom calcula excesul de mortalitate în maniera uzuală, adică prin formula următoare:\n\n$$\nExces_{w_i}^{y_j} = \\frac{Decese_{w_i}^{y_j} - \\frac{1}{4} \\sum_{j=2015}^{j=2019} Decese_{w_i}^{y_j}}{\\frac{1}{4} \\sum_{j=2015}^{j=2019} Decese_{w_i}^{y_j}}\n$$\n\nUnde $Exces_{w_i, y_j}$ este excesul de mortalitate din săptămâna i, anul j.\n\n```{r}\n\nlibrary(tidyverse)\nlibrary(eurostat)\nlibrary(hrbrthemes)\nlibrary(ggthemes)\nlibrary(sf)\n\ntheme_set(hrbrthemes::theme_ipsum_tw(strip_text_size = 14, \n                                     strip_text_family = \"Roboto\",\n                                     strip_text_face = \"italic\",\n                                     axis_title_size = 12,\n                                     axis_text_size = 10,\n                                     base_family = \"Roboto\",\n                                     plot_title_family = \"Roboto\",\n                                     subtitle_family = \"Roboto\",\n                                     caption_family = \"Roboto\", \n                                     caption_size = 10,\n                                     plot_title_size = 16,\n                                     subtitle_size = 12) +\n  theme(legend.text = element_text(size=10), \n        legend.title = element_text(size=12),\n        legend.key.size = unit(0.5, \"cm\")))  #setam tema graficelor \n\n#x <- get_eurostat(id=\"demo_r_mwk3_10\") \nx <- read_csv(here::here(\"data\", \"post-5\", \"exces.csv\"))\n\nconvert <-function(x){\n  if(nchar(x)==1){\n    paste0(\"0\", x)\n  } else {\n    x\n  }\n}\n\nconvert <- Vectorize(convert, SIMPLIFY = TRUE)\n\n```\n\n```{r}\n#| fig-width: 8\n#| fig-height: 6\n#| fig-dpi: 200\n#| label: \"desfasurata\"\n\nexces_2020 <- x %>% filter(year>2014) %>% filter(week<54, year!=2023) %>%\n  mutate(index = if_else(year%in%c(2015:2019), 0, year)) %>% \n  group_by(age, geo, index, week) %>% \n  summarise(normal = mean(values, na.rm=TRUE)) %>% \n  ungroup() %>% spread(index, normal) %>% drop_na() %>%\n  mutate(across(`2020`:`2022`, ~100*(.-`0`)/`0`))\n\nexces <- exces_2020 %>% \n  filter(week<55) %>% \n  gather(`2020`:`2022`, key='ani', value='exces') %>% \n  mutate(time = paste0(ani, \"-W\",convert(week), \"-3\") %>% \n                ISOweek::ISOweek2date(.))\n\n\nexces %>% \n  filter(age=='TOTAL', grepl(\"^[A-Z]{2}$\",geo)) %>% \n  ggplot(aes(x=time, y=exces, group=geo)) + geom_line(aes(colour=geo),\n                                                      size=1) +\n  gghighlight::gghighlight(geo%in%c(\"RO\",\"BG\",\"HU\",\"PL\",\"CZ\"),\n                           use_direct_label = FALSE,\n                           unhighlighted_params = list(size=0.5),\n                           calculate_per_facet = TRUE) +\n  scale_color_tableau() +\n  labs(title=\"Excesul de mortalitate în Europa\", x=NULL, y=\"Exces (%)\",\n       caption='Sursa: Eurostat, demo_r_mwk_3_10', \n       subtitle=\"Raportat la media 2015-2019\", colour='Ţară') +\n  scale_y_continuous(labels=scales::percent_format(scale=1)) +\n  geom_hline(yintercept=0, linetype=2)\n```\n\nAm stat destul de rău, fiind destul de sus la mortalitate în perioadele-cheie ale pandemiei. Să vedem mortalităţile pe categorii de vârste.\n\n```{r}\n#| fig-width: 8\n#| fig-height: 12\n#| fig-dpi: 200\n\n\nexces_age <- x %>% \n  filter(year>2014) %>% filter(week<54, year!=2023) %>%\n  filter(grepl(\"^[A-Z]{2}$\", geo)) %>% \n  mutate(time = paste0(year, \"-W\", convert(week), \"-3\") %>% ISOweek::ISOweek2date(.)) %>%\n  mutate(month=lubridate::month(time)) %>%\n  mutate(index = if_else(year%in%c(2015:2019), 0, year)) %>% \n  group_by(age, index, month) %>% \n  summarise(normal = mean(values, na.rm=TRUE)) %>% \n  ungroup() %>% spread(index, normal) %>% drop_na() %>%\n  mutate(across(`2020`:`2022`, ~100*(.-`0`)/`0`)) %>%\n  gather(`2020`:`2022`, key='year', value='exces') %>%\n  mutate(time = paste0(year, \"-\", convert(month), \"-01\") %>% as.Date(.))\n\n\nexces_age %>% filter(!grepl(\"TOTAL|UNK|GE80\", age)) %>% \n    ggplot(aes(x=time, y=exces, fill=age)) + geom_col(aes(fill=age)) +\n    scale_y_continuous(labels=scales::percent_format(scale=1)) +\n    scale_fill_tableau() + facet_wrap(~age, ncol=2, scales='free') +\n    labs(title=\"Excesul de mortalitate pe vârste şi luni\", \n         caption='Sursa: Eurostat, r_demo_mwk_3_10', x=NULL, y=\"%\")\n  \n\n\n```\n\nInteresant, cei tineri au avut mortalităţi mai mici în general, abia la intervalul 50-59 ani începe să se balanseze situaţia. Categoria 60-69 de ani are deja mortalitate constant pozitivă în perioadele-cheie ale pandemiei.\n\nSă vizualizăm o hartă europeană cu excesul mediu de mortalitate după anul 2020 până în prezent.\n\n```{r}\n#| fig-width: 10\n#| fig-height: 8\n#| fig-dpi: 200\n\nexces_geo <- x %>% \n    filter(year>2014) %>% filter(week<54, year!=2023) %>%\n    mutate(index = if_else(year%in%c(2015:2019), 0, 1)) %>% \n    filter(age==\"TOTAL\") %>%\n    group_by(age, geo, index) %>% \n    summarise(normal = mean(values, na.rm=TRUE)) %>% \n    ungroup() %>% spread(index, normal) %>% drop_na() %>% select(-age) %>%\n    mutate(exces = 100*(`1`-`0`)/`0`)\n\nharta <- eurostat::eurostat_geodata_60_2016 %>% as_tibble() %>%\n         mutate(index = if_else(grepl(\"^DE\", geo) & LEVL_CODE>1, 0, 1)) %>% \n         filter(index!=0) %>%\n         group_by(CNTR_CODE) %>% slice_max(order_by=LEVL_CODE, n=1) %>% ungroup() \n\nexces_geo %>% inner_join(harta) %>% \n  mutate(exces=cut_number(exces, n=10)) %>% st_as_sf() %>%\n  ggplot() + geom_sf(aes(fill=exces), colour=NA) +\n  geom_sf(data = {eurostat::eurostat_geodata_60_2016 %>% filter(LEVL_CODE==0) %>%\n                 st_as_sf() %>% st_cast(., \"MULTILINESTRING\") %>% \n                 as_tibble() %>% st_as_sf()} , \n          colour='black') +\n  scale_fill_tableau(palette = \"Classic Orange-Blue\", \n                     type=\"ordered-diverging\", direction = -1) +\n  scale_x_continuous(limits = c(-11, 30)) +\n  scale_y_continuous(limits = c(35, 70))\n  \n```\n\nInteresant la această hartă este diviziunea Germaniei de Est de cea de Vest. Istoria contează aparent şi când e vorba de mortalitatea de COVID.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"toc-depth":3,"output-file":"geografia-excesului-de-mortalitate.html"},"language":{"code-summary":"Arată codul"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"0.9.481","editor":"visual","theme":"spacelab","title-block-banner":true,"page-layout":"article","comments":{"utterances":{"repo":"buciupetre2020/blogComments"}},"title":"Geografia excesului de mortalitate","description":"În ce regiuni a lovit pandemia cel mai tare ?\n","author":[{"name":"Petre Buciu","url":{}}],"knitr":{"opts_chunk":{"fig.align":"center"}},"date":"06-07-2023"},"extensions":{"book":{"multiFile":true}}}}}